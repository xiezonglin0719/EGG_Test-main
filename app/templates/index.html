<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EEG Waveform (10s, Channel 1)</title>
  <script src="chart.umd.min.js"></script>
</head>
<body>
  <h1>EEG Waveform - Channel 1 (Rolling 10s)</h1>
  <canvas id="eegChart" width="800" height="400"></canvas>

  <script>
    // 假设设备 1000Hz，每秒发 1000 个点
    // 保留 10 秒 => 10 * 1000 = 10000 点
    const SAMPLES_PER_SECOND = 1000;
    const SECONDS_TO_DISPLAY = 10;
    const TOTAL_POINTS = SAMPLES_PER_SECOND * SECONDS_TO_DISPLAY;  // 10000

    // 1) X 轴: 0到10秒(共10000个点)
    // 每个点间隔 0.001 秒 => i * 0.001
    const xLabels = Array.from({ length: TOTAL_POINTS }, (_, i) => (i / SAMPLES_PER_SECOND).toFixed(3));

    // 2) 准备一个用于存储最近10秒数据的缓冲
    let channelDataBuffer = Array(TOTAL_POINTS).fill(0);

    // 3) 创建 Chart.js
    const ctx = document.getElementById('eegChart').getContext('2d');
    let eegChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: xLabels,  // 0 ~ 10秒
        datasets: [
          {
            label: 'Channel 1', // 改为展示第二通道
            data: channelDataBuffer,
            borderColor: 'blue',
            borderWidth: 1,
            pointRadius: 0,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: {
            display: true,
            title: { display: true, text: 'Time (s)' }
          },
          y: {
            display: true,
            title: { display: true, text: 'Amplitude' }
          }
        }
      }
    });

    // 4) 建立 WebSocket 连接
    const socket = new WebSocket('ws://localhost:8765');
    socket.onopen = () => {
      console.log('WebSocket connected');
    };

    // 每当收到 1 秒(1000点)数据时，把它追加到缓冲末尾，移除最旧的部分
    socket.onmessage = (event) => {
      const received = JSON.parse(event.data);
      // 使用 received.channels[1] 来获取第二通道
      if (received.channels && received.channels[1]) {
        let newData = received.channels[1]; // 第二通道，索引1

        // 拼接
        channelDataBuffer = channelDataBuffer.concat(newData);
        // 保持只保留最后 10000 点
        channelDataBuffer.splice(0, newData.length);

        // 更新 chart 数据
        eegChart.data.datasets[0].data = channelDataBuffer;
        eegChart.update();
      }
    };

    socket.onclose = () => {
      console.log('WebSocket disconnected');
    };
    socket.onerror = (err) => {
      console.error('WebSocket error:', err);
    };
  </script>
</body>
</html>
